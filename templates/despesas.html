{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-minus-circle me-2"></i>Despesas</h2>
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalDespesa">
                <i class="fas fa-plus me-2"></i>Nova Despesa
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="filtroCategoria" class="form-label">
                            <i class="fas fa-filter me-2"></i>Filtrar por Categoria
                        </label>
                        <select class="form-select" id="filtroCategoria">
                            <option value="">Todas as categorias</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.nome }}" data-id="{{ categoria.id }}">{{ categoria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroSubcategoria" class="form-label">
                            <i class="fas fa-filter me-2"></i>Filtrar por Subcategoria
                        </label>
                        <select class="form-select" id="filtroSubcategoria">
                            <option value="">Todas as subcategorias</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroStatusDespesa" class="form-label">
                            <i class="fas fa-filter me-2"></i>Status
                        </label>
                        <select class="form-select" id="filtroStatusDespesa">
                            <option value="">Todos</option>
                            <option value="pendente">Pendente</option>
                            <option value="efetivado">Pago</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-secondary w-100" onclick="limparFiltros()">
                            <i class="fas fa-times me-2"></i>Limpar Filtros
                        </button>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-dollar-sign me-2"></i>Total
                                </h6>
                                <h4 class="mb-0" id="totalDespesas">R$ 0,00</h4>
                                <small id="contadorDespesas">0 despesa(s)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Data</th>
                                <th>Categoria</th>
                                <th>Subcategoria</th>
                                <th>Tipo de Pagamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-despesas">
                            {% for despesa in despesas %}
                            <tr>
                                <td>
                                    {{ despesa.descricao }}
                                    {% if despesa.parcelas > 1 %}
                                    <br><small class="text-muted">Parcela {{ despesa.parcela_atual }}/{{ despesa.parcelas }}</small>
                                    {% endif %}
                                </td>
                                <td class="fw-bold">
                                    {% if despesa.valor_previsto %}
                                        <div class="text-muted small">Previsto: R$ {{ "{:,.2f}".format(despesa.valor_previsto).replace(',', '_').replace('.', ',').replace('_', '.') }}</div>
                                    {% endif %}
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" min="0" 
                                               class="form-control form-control-sm valor-input"
                                               value="{{ "%.2f"|format(despesa.valor or 0) }}"
                                               data-id="{{ despesa.id }}"
                                               data-original="{{ "%.2f"|format(despesa.valor or 0) }}"
                                               data-compra-parcelada="{{ despesa.compra_parcelada_id or '' }}"
                                               onchange="atualizarValorDespesa(this)">
                                    </div>
                                    {% if despesa.parcelas > 1 %}
                                        <small class="text-muted">Total previsto: R$ {{ "{:,.2f}".format(despesa.valor_previsto * despesa.parcelas).replace(',', '_').replace('.', ',').replace('_', '.') }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ despesa.data.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ despesa.categoria }}</span>
                                    <div class="form-check form-switch d-inline-block ms-2">
                                        <input class="form-check-input" type="checkbox"
                                               id="statusDespesa{{ despesa.id }}"
                                               data-compra-parcelada="{{ despesa.compra_parcelada_id or '' }}"
                                               {{ 'checked' if despesa.efetivado else '' }}
                                               onchange="alternarStatusDespesa(this, {{ despesa.id }}, {{ 'true' if despesa.valor else 'false' }})">
                                        <label class="form-check-label" for="statusDespesa{{ despesa.id }}">
                                            {% if despesa.efetivado %}
                                                <span class="badge bg-success">Pago</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">Pendente</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </td>
                                <td>{% if despesa.subcategoria %}<span class="badge bg-info text-dark">{{ despesa.subcategoria }}</span>{% else %}-{% endif %}</td>
                                <td>{% if despesa.tipo_pagamento %}<span class="badge bg-primary">{{ despesa.tipo_pagamento.nome }}</span>{% else %}-{% endif %}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deletarDespesa({{ despesa.id }}, {{ despesa.compra_parcelada_id if despesa.compra_parcelada_id else 'null' }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nova Despesa -->
<div class="modal fade" id="modalDespesa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Despesa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDespesa">
                    <div class="mb-3">
                        <label for="descricaoDespesa" class="form-label">Descrição</label>
                        <input type="text" class="form-control" id="descricaoDespesa" required>
                    </div>
                    <div class="mb-3">
                        <label for="valorPrevistoDespesa" class="form-label">Valor Previsto</label>
                        <input type="number" class="form-control" id="valorPrevistoDespesa" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="valorDespesa" class="form-label">Valor Efetivo</label>
                        <input type="number" class="form-control" id="valorDespesa" step="0.01" min="0">
                        <small class="form-text text-muted">Deixe em branco se ainda não foi pago</small>
                    </div>
                    <div class="mb-3">
                        <label for="dataDespesa" class="form-label">Data</label>
                        <input type="date" class="form-control" id="dataDespesa" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="efetivoDespesa">
                            <label class="form-check-label" for="efetivoDespesa">Despesa já paga?</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="categoriaDespesa" class="form-label">Categoria</label>
                        <select class="form-select" id="categoriaDespesa" required>
                            <option value="">Selecione uma categoria</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" data-nome="{{ categoria.nome }}">{{ categoria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="subcategoriaDespesa" class="form-label">Subcategoria</label>
                        <select class="form-select" id="subcategoriaDespesa">
                            <option value="">Selecione uma subcategoria</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="tipoPagamentoDespesa" class="form-label">Tipo de Pagamento</label>
                        <select class="form-select" id="tipoPagamentoDespesa">
                            <option value="">Selecione o tipo de pagamento</option>
                            {% for tipo in tipos_pagamento %}
                            {% if tipo.ativo %}
                            <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="parcelamentoDespesa" class="form-label">Parcelamento</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="parcelamentoDespesa" min="1" max="48" value="1">
                            <span class="input-group-text">parcela(s)</span>
                        </div>
                        <small class="text-muted">Deixe 1 para pagamento à vista</small>
                    </div>

                    <div id="infoParcelamento" class="alert alert-info d-none">
                        <small>
                            <span id="valorParcela"></span><br>
                            <span id="datasParcelas"></span>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="salvarDespesa()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function atualizarTotalDespesas(total, contador) {
    const totalElement = document.getElementById('totalDespesas');
    const contadorElement = document.getElementById('contadorDespesas');
    
    // Arredonda para 2 casas decimais mantendo precisão
    total = Number(total.toFixed(2));
    
    if (totalElement) {
        // Formata o número no padrão brasileiro (ex: R$ 1.234,56)
        const valorFormatado = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(total);
        
        totalElement.textContent = valorFormatado;
    }
    
    if (contadorElement) {
        contadorElement.textContent = contador === 1 ? '1 despesa' : `${contador} despesas`;
    }
}

function filtrarTabela() {
    const filtroCategoria = document.getElementById('filtroCategoria');
    const filtroSubcategoria = document.getElementById('filtroSubcategoria');
    const categoriaFiltro = filtroCategoria ? filtroCategoria.value : '';
    const subcategoriaFiltro = filtroSubcategoria ? filtroSubcategoria.value : '';
    const linhas = document.getElementById('tabela-despesas').getElementsByTagName('tr');
    
    let total = 0;
    let contador = 0;
    
    Array.from(linhas).forEach(linha => {
        const categoriaCell = linha.querySelector('td:nth-child(4)');
        const subcategoriaCell = linha.querySelector('td:nth-child(5)');
        const valorCell = linha.querySelector('td:nth-child(2)');
            const filtroStatus = document.getElementById('filtroStatusDespesa');
            const statusFiltro = filtroStatus ? filtroStatus.value : '';
        
        if (!categoriaCell) return;
        
        // Extrair texto da categoria (pode estar dentro de um badge)
        const categoriaBadge = categoriaCell.querySelector('.badge');
        const categoriaTexto = categoriaBadge ? categoriaBadge.textContent.trim() : categoriaCell.textContent.trim();
        
        // Extrair texto da subcategoria (pode estar dentro de um badge ou ser '-')
        let subcategoriaTexto = '';
        if (subcategoriaCell) {
            const subcategoriaBadge = subcategoriaCell.querySelector('.badge');
            subcategoriaTexto = subcategoriaBadge ? subcategoriaBadge.textContent.trim() : subcategoriaCell.textContent.trim();
            subcategoriaTexto = subcategoriaTexto === '-' ? '' : subcategoriaTexto;
        }
        
        let mostrar = true;
        
        // Filtrar por categoria
        if (categoriaFiltro && categoriaTexto.toLowerCase() !== categoriaFiltro.toLowerCase()) {
            mostrar = false;
        }
        
        // Filtrar por subcategoria
        if (mostrar && subcategoriaFiltro && subcategoriaTexto.toLowerCase() !== subcategoriaFiltro.toLowerCase()) {
            mostrar = false;
        }

        // Filtrar por status (Pago / Pendente)
        if (mostrar && statusFiltro) {
            const statusCell = linha.querySelector('td:nth-child(4)');
            const statusBadge = statusCell ? statusCell.querySelector('label .badge') : null;
            const statusTexto = statusBadge ? statusBadge.textContent.trim().toLowerCase() : '';
            const esperado = statusFiltro === 'efetivado' ? 'pago' : 'pendente';
            if (!statusTexto.includes(esperado)) {
                mostrar = false;
            }
        }
        
        // Mostrar ou ocultar linha
        linha.style.display = mostrar ? '' : 'none';
        
        // Calcular total das linhas visíveis
        if (mostrar && valorCell) {
            contador++;
            // Extrair valor da célula
            const valorTexto = valorCell.textContent.trim();
            // Remover "Total: R$ X" se existir e pegar apenas o valor da parcela
            const linhaValor = valorTexto.split('\n')[0]; // Pega apenas a primeira linha
            const match = linhaValor.match(/R\$\s*([\d.,]+)/);
            if (match) {
                // Converter para número (substituir pontos de milhar e vírgula decimal)
                let valorStr = match[1];
                // Remove todos os pontos, exceto o último que será substituído por ponto decimal
                valorStr = valorStr.replace(/\./g, '').replace(',', '.');
                const valor = parseFloat(valorStr);
                if (!isNaN(valor)) {
                    total += valor;
                }
            }
        }
    });
    
    // Atualizar total e contador na tela
    atualizarTotalDespesas(total, contador);
}

// Função para atualizar o total exibido
function atualizarTotalDespesas(total, contador) {
    const totalElement = document.getElementById('totalDespesas');
    const contadorElement = document.getElementById('contadorDespesas');
    
    // Arredonda para 2 casas decimais
    total = Math.round(total * 100) / 100;
    
    if (totalElement) {
        totalElement.textContent = total.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    if (contadorElement) {
        contadorElement.textContent = contador === 1 ? '1 despesa' : `${contador} despesas`;
    }
}

// Função para limpar filtros
function limparFiltros() {
    const filtroCategoria = document.getElementById('filtroCategoria');
    const filtroSubcategoria = document.getElementById('filtroSubcategoria');
    const filtroStatus = document.getElementById('filtroStatusDespesa');
    
    if (filtroCategoria) filtroCategoria.value = '';
    if (filtroSubcategoria) {
        filtroSubcategoria.value = '';
        filtroSubcategoria.innerHTML = '<option value="">Todas as subcategorias</option>';
    }
    if (filtroStatus) filtroStatus.value = '';
    filtrarTabela();
}

document.addEventListener('DOMContentLoaded', function() {
    // Definir data atual como padrão
    const dataInput = document.getElementById('dataDespesa');
    if (dataInput) {
        dataInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Filtros de categoria e subcategoria
    const filtroCategoria = document.getElementById('filtroCategoria');
    const filtroSubcategoria = document.getElementById('filtroSubcategoria');
    const filtroStatus = document.getElementById('filtroStatusDespesa');
    
    // Quando o filtro de categoria mudar, atualizar subcategorias e filtrar tabela
    if (filtroCategoria) {
        filtroCategoria.addEventListener('change', function() {
            const categoriaNome = this.value;
            atualizarFiltroSubcategorias(categoriaNome);
            filtrarTabela();
        });
    }
    if (filtroStatus) {
        filtroStatus.addEventListener('change', filtrarTabela);
    }
    // Quando o filtro de subcategoria mudar, filtrar tabela
    if (filtroSubcategoria) {
        filtroSubcategoria.addEventListener('change', function() {
            filtrarTabela();
        });
    }
    
    // Quando categoria mudar no modal, carregar subcategorias
    const categoriaSelect = document.getElementById('categoriaDespesa');
    const subcategoriaSelect = document.getElementById('subcategoriaDespesa');
    if (categoriaSelect) {
        categoriaSelect.addEventListener('change', function() {
            const categoriaId = this.value;
            // limpar opções
            if (subcategoriaSelect) {
                subcategoriaSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            }
            if (!categoriaId) return;
            fetch(`/api/subcategorias/${categoriaId}`)
                .then(resp => resp.json())
                .then(data => {
                    if (Array.isArray(data) && subcategoriaSelect) {
                        data.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s.nome || s.id;
                            opt.textContent = s.nome;
                            subcategoriaSelect.appendChild(opt);
                        });
                    }
                })
                .catch(err => console.error('Erro ao obter subcategorias:', err));
        });
    }
    
    // Calcular total inicial ao carregar a página
    setTimeout(() => {
        filtrarTabela();
    }, 200);
    // adicionar listener para atualizar total quando os inputs mudarem
    document.querySelectorAll('input.valor-input').forEach(inp => inp.addEventListener('change', filtrarTabela));
    
    // Event listeners para atualização do parcelamento
    const parcelamentoInput = document.getElementById('parcelamentoDespesa');
    const valorInput = document.getElementById('valorDespesa');
    const dataInputModal = document.getElementById('dataDespesa');

    // Atualizar info do parcelamento quando os valores mudarem
    if (parcelamentoInput && valorInput && dataInputModal) {
        [parcelamentoInput, valorInput, dataInputModal].forEach(input => {
            input.addEventListener('input', atualizarInfoParcelamento);
        });
    }
});

// Função para atualizar subcategorias no filtro
function atualizarFiltroSubcategorias(categoriaNome) {
    const filtroSubcategoria = document.getElementById('filtroSubcategoria');
    if (!filtroSubcategoria) return;
    
    filtroSubcategoria.innerHTML = '<option value="">Todas as subcategorias</option>';
    
    if (!categoriaNome) {
        return; // Se não há categoria, não carregar subcategorias
    }
    
    // Buscar categoria pelo nome para obter o ID
    const categoriaOption = document.querySelector(`#filtroCategoria option[value="${categoriaNome}"]`);
    if (!categoriaOption) return;
    
    // Tentar obter ID da categoria
    const categoriaId = categoriaOption.getAttribute('data-id');
    if (categoriaId) {
        fetch(`/api/subcategorias/${categoriaId}`)
            .then(resp => resp.json())
            .then(data => {
                if (Array.isArray(data)) {
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.nome;
                        opt.textContent = s.nome;
                        filtroSubcategoria.appendChild(opt);
                    });
                }
            })
            .catch(err => console.error('Erro ao carregar subcategorias:', err));
    }
}


// Função para atualizar informações do parcelamento
function atualizarInfoParcelamento() {
    const valor = parseFloat(document.getElementById('valorDespesa').value) || 0;
    const parcelas = parseInt(document.getElementById('parcelamentoDespesa').value) || 1;
    const dataInicial = document.getElementById('dataDespesa').value;
    const infoDiv = document.getElementById('infoParcelamento');
    
    if (parcelas > 1 && valor > 0 && dataInicial) {
        const valorParcela = valor / parcelas;
        const dataInicialObj = new Date(dataInicial);
        
        // Formatar primeira e última data
        const dataFinalObj = new Date(dataInicialObj);
        dataFinalObj.setMonth(dataFinalObj.getMonth() + parcelas - 1);
        
        const formatarData = (data) => data.toLocaleDateString('pt-BR');
        
        const valorParcelaFormatado = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Number(valorParcela.toFixed(2)));
        
        document.getElementById('valorParcela').textContent = `Valor por parcela: ${valorParcelaFormatado}`;
        document.getElementById('datasParcelas').textContent = 
            `Período: ${formatarData(dataInicialObj)} até ${formatarData(dataFinalObj)}`;
        
        infoDiv.classList.remove('d-none');
    } else {
        infoDiv.classList.add('d-none');
    }
}

function salvarDespesa() {
    const descricao = document.getElementById('descricaoDespesa').value;
    const valorPrevisto = document.getElementById('valorPrevistoDespesa').value;
    const valorEfetivo = document.getElementById('valorDespesa').value;
    const data = document.getElementById('dataDespesa').value;
    const categoriaSelect = document.getElementById('categoriaDespesa');
    const categoria = categoriaSelect.value;
    const categoriaNome = categoriaSelect.options[categoriaSelect.selectedIndex]?.dataset?.nome || categoriaSelect.options[categoriaSelect.selectedIndex]?.text;
    const subcategoria = document.getElementById('subcategoriaDespesa').value;
    const parcelas = parseInt(document.getElementById('parcelamentoDespesa').value) || 1;
    const efetivado = document.getElementById('efetivoDespesa').checked;

    if (!descricao || !valorPrevisto || !data || !categoria) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    const dados = {
        descricao: descricao,
        valor_previsto: parseFloat(valorPrevisto),
        valor: valorEfetivo ? parseFloat(valorEfetivo) : null,
        data: data,
        categoria: categoriaNome,
        subcategoria: subcategoria || null,
        tipo_pagamento_id: document.getElementById('tipoPagamentoDespesa').value || null,
        parcelas: parcelas,
        efetivado: efetivado
    };
    
    fetch('/api/despesa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDespesa'));
            if (modal) modal.hide();
            // Recarregar página para atualizar tabela e total
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar despesa.');
    });
}

// Função para atualizar o valor de uma despesa
async function atualizarValorDespesa(input) {
    const id = input.dataset.id;
    const novoValor = parseFloat(input.value);
    const valorOriginal = parseFloat(input.dataset.original);
    const compraParceladaId = input.dataset.compraParcelada;
    
    if (isNaN(novoValor) || novoValor < 0) {
        input.value = input.dataset.original;
        mostrarNotificacao('Valor inválido!', 'danger');
        return;
    }
    
    if (novoValor === valorOriginal) {
        return;
    }
    
    if (compraParceladaId) {
        const atualizarTodas = confirm('Esta é uma despesa parcelada. Deseja atualizar todas as parcelas proporcionalmente?');
        
        try {
            const checkbox = document.getElementById(`statusDespesa${id}`);
            const resultado = await atualizarDespesa(id, novoValor, checkbox.checked, compraParceladaId, atualizarTodas);
            
            if (resultado.success) {
                input.dataset.original = novoValor;
                mostrarNotificacao(resultado.message, 'success');
                filtrarTabela();
            }
        } catch (error) {
            input.value = input.dataset.original;
            mostrarNotificacao('Erro ao atualizar valor!', 'danger');
        }
    } else {
        try {
            const checkbox = document.getElementById(`statusDespesa${id}`);
            const resultado = await atualizarDespesa(id, novoValor, checkbox.checked);
            
            if (resultado.success) {
                input.dataset.original = novoValor;
                mostrarNotificacao(resultado.message, 'success');
                filtrarTabela();
            }
        } catch (error) {
            input.value = input.dataset.original;
            mostrarNotificacao('Erro ao atualizar valor!', 'danger');
        }
    }
}

// Função para alternar o status (previsto/efetivado) de uma despesa
async function alternarStatusDespesa(checkbox, id, temValor) {
    const efetivado = checkbox.checked;
    const compraParceladaId = checkbox.dataset.compraParcelada;
    
    if (compraParceladaId) {
        const atualizarTodas = confirm('Esta é uma despesa parcelada. Deseja atualizar o status de todas as parcelas?');
        
        try {
            const input = document.querySelector(`input[data-id="${id}"]`);
            const valor = parseFloat(input.value);
            
            const resultado = await atualizarDespesa(id, valor, efetivado, compraParceladaId, atualizarTodas);
            
            if (resultado.success) {
                input.value = resultado.data.valor;
                input.dataset.original = resultado.data.valor;
                
                // Atualizar badge de status
                const label = checkbox.nextElementSibling;
                const badge = label.querySelector('.badge');
                if (resultado.data.efetivado) {
                    badge.className = 'badge bg-success';
                    badge.textContent = 'Pago';
                } else {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = 'Pendente';
                }
                
                mostrarNotificacao(resultado.message, 'success');
                filtrarTabela();
            }
        } catch (error) {
            checkbox.checked = !efetivado;
            mostrarNotificacao('Erro ao atualizar status!', 'danger');
        }
    } else {
        try {
            const input = document.querySelector(`input[data-id="${id}"]`);
            const valor = parseFloat(input.value);
            
            const resultado = await atualizarDespesa(id, valor, efetivado);
            
            if (resultado.success) {
                input.value = resultado.data.valor;
                input.dataset.original = resultado.data.valor;
                
                // Atualizar badge de status
                const label = checkbox.nextElementSibling;
                const badge = label.querySelector('.badge');
                if (resultado.data.efetivado) {
                    badge.className = 'badge bg-success';
                    badge.textContent = 'Pago';
                } else {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = 'Pendente';
                }
                
                mostrarNotificacao(resultado.message, 'success');
                filtrarTabela();
            }
        } catch (error) {
            checkbox.checked = !efetivado;
            mostrarNotificacao('Erro ao atualizar status!', 'danger');
        }
    }
}

function deletarDespesa(id, compraParceladaId) {
    let mensagem = 'Tem certeza que deseja deletar esta despesa?';
    if (compraParceladaId) {
        mensagem = 'Esta é uma compra parcelada. Deseja deletar:\n\n' +
                  '1 - Apenas esta parcela\n' +
                  '2 - Todas as parcelas futuras\n' +
                  '3 - Todas as parcelas da compra\n\n' +
                  'Digite 1, 2 ou 3:';
        
        const opcao = prompt(mensagem);
        if (!opcao || !['1', '2', '3'].includes(opcao)) {
            return;
        }
        
        // Adicionar a opção à URL
        const url = `/api/despesa/${id}?opcao_delete=${opcao}&compra_parcelada_id=${compraParceladaId}`;
        
        fetch(url, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao deletar despesa.');
            });
    } else {
        // Despesa normal (não parcelada)
        if (confirm(mensagem)) {
            fetch(`/api/despesa/${id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao deletar despesa.');
                });
        }
    }
}
</script>
{% endblock %}
